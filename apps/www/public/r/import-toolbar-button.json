{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "import-toolbar-button",
  "type": "registry:ui",
  "title": "Import Toolbar Button",
  "description": "A toolbar button to import editor content from a file.",
  "dependencies": [
    "use-file-picker@2.1.2"
  ],
  "registryDependencies": [
    "dropdown-menu",
    "https://platejs.org/r/toolbar"
  ],
  "files": [
    {
      "path": "src/registry/ui/import-toolbar-button.tsx",
      "content": "'use client';\n\nimport * as React from 'react';\n\nimport type { DropdownMenuProps } from '@radix-ui/react-dropdown-menu';\n\nimport { getCommentKey } from '@platejs/comment';\nimport { importDocxWithTracking } from '@platejs/docx-io';\nimport { MarkdownPlugin } from '@platejs/markdown';\nimport { getSuggestionKey } from '@platejs/suggestion';\nimport { ArrowUpToLineIcon } from 'lucide-react';\nimport { KEYS, TextApi } from 'platejs';\nimport { useEditorRef } from 'platejs/react';\nimport { getEditorDOMFromHtmlString } from 'platejs/static';\nimport { useFilePicker } from 'use-file-picker';\n\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuGroup,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\n\nimport { commentPlugin } from '@/registry/components/editor/plugins/comment-kit';\nimport {\n  discussionPlugin,\n  type TDiscussion,\n} from '@/registry/components/editor/plugins/discussion-kit';\nimport { getDiscussionCounterSeed } from '../lib/discussion-ids';\nimport { ToolbarButton } from './toolbar';\n\ntype ImportType = 'html' | 'markdown';\n\nconst WHITESPACE_REGEX = /\\s+/;\n\nexport function ImportToolbarButton(props: DropdownMenuProps) {\n  const editor = useEditorRef();\n  const [open, setOpen] = React.useState(false);\n\n  const getFileNodes = (text: string, type: ImportType) => {\n    if (type === 'html') {\n      const editorNode = getEditorDOMFromHtmlString(text);\n      const nodes = editor.api.html.deserialize({\n        element: editorNode,\n      });\n\n      return nodes;\n    }\n\n    if (type === 'markdown') {\n      return editor.getApi(MarkdownPlugin).markdown.deserialize(text);\n    }\n\n    return [];\n  };\n\n  const { openFilePicker: openMdFilePicker } = useFilePicker({\n    accept: ['.md', '.mdx'],\n    multiple: false,\n    onFilesSelected: async ({ plainFiles }) => {\n      const text = await plainFiles[0].text();\n\n      const nodes = getFileNodes(text, 'markdown');\n\n      editor.tf.insertNodes(nodes);\n    },\n  });\n\n  const { openFilePicker: openHtmlFilePicker } = useFilePicker({\n    accept: ['text/html'],\n    multiple: false,\n    onFilesSelected: async ({ plainFiles }) => {\n      const text = await plainFiles[0].text();\n\n      const nodes = getFileNodes(text, 'html');\n\n      editor.tf.insertNodes(nodes);\n    },\n  });\n\n  const { openFilePicker: openDocxFilePicker } = useFilePicker({\n    accept: ['.docx'],\n    multiple: false,\n    onFilesSelected: async ({ plainFiles }) => {\n      const arrayBuffer = await plainFiles[0].arrayBuffer();\n\n      // Compute next discussion number to avoid ID collisions\n      const existingDiscussions =\n        editor.getOption(discussionPlugin, 'discussions') ?? [];\n      let discussionCounter = getDiscussionCounterSeed(existingDiscussions);\n\n      // Import with full tracking support (suggestions + comments)\n      const result = await importDocxWithTracking(editor as any, arrayBuffer, {\n        suggestionKey: KEYS.suggestion,\n        getSuggestionKey,\n        commentKey: KEYS.comment,\n        getCommentKey,\n        isText: TextApi.isText,\n        generateId: () => `discussion${++discussionCounter}`,\n      });\n\n      // Register imported users so suggestion/comment UI can resolve them\n      if (result.users.length > 0) {\n        const existingUsers = editor.getOption(discussionPlugin, 'users') ?? {};\n        const updatedUsers = { ...existingUsers };\n\n        for (const user of result.users) {\n          if (!updatedUsers[user.id]) {\n            updatedUsers[user.id] = {\n              id: user.id,\n              name: user.name,\n              avatarUrl: `https://api.dicebear.com/9.x/glass/svg?seed=${encodeURIComponent(user.name)}`,\n            };\n          }\n        }\n\n        editor.setOption(discussionPlugin, 'users', updatedUsers);\n      }\n\n      // Convert imported discussions to TDiscussion format (empty array if none)\n      const newDiscussions: TDiscussion[] = (result.discussions ?? []).map(\n        (d) => ({\n          id: d.id,\n          comments: (d.comments ?? []).map((c, index) => ({\n            id: c.id || `comment${index + 1}`,\n            contentRich:\n              c.contentRich as TDiscussion['comments'][number]['contentRich'],\n            createdAt: c.createdAt ?? new Date(),\n            discussionId: d.id,\n            isEdited: false,\n            userId: c.userId ?? c.user?.id ?? 'imported-unknown',\n            authorName: c.user?.name,\n            authorInitials: c.user?.name\n              ? c.user.name\n                  .split(WHITESPACE_REGEX)\n                  .slice(0, 2)\n                  .map((w) => w[0]?.toUpperCase() ?? '')\n                  .join('')\n              : undefined,\n            paraId: c.paraId,\n            parentParaId: c.parentParaId,\n          })),\n          createdAt: d.createdAt ?? new Date(),\n          documentContent: d.documentContent,\n          isResolved: false,\n          userId: d.userId ?? d.user?.id ?? 'imported-unknown',\n          authorName: d.user?.name,\n          authorInitials: d.user?.name\n            ? d.user.name\n                .split(WHITESPACE_REGEX)\n                .slice(0, 2)\n                .map((w) => w[0]?.toUpperCase() ?? '')\n                .join('')\n            : undefined,\n          paraId: d.paraId,\n        })\n      );\n\n      // Replace all discussions (not append) because importDocxWithTracking\n      // replaces the entire editor content, making old discussions stale\n      editor.setOption(discussionPlugin, 'discussions', newDiscussions);\n      editor.setOption(commentPlugin, 'uniquePathMap', new Map());\n\n      // Log import results in dev only\n      if (\n        result.hasTracking &&\n        result.errors.length > 0 &&\n        process.env.NODE_ENV !== 'production'\n      ) {\n        console.warn('[DOCX Import] Errors:', result.errors);\n      }\n    },\n  });\n\n  return (\n    <DropdownMenu open={open} onOpenChange={setOpen} modal={false} {...props}>\n      <DropdownMenuTrigger asChild>\n        <ToolbarButton pressed={open} tooltip=\"Import\" isDropdown>\n          <ArrowUpToLineIcon className=\"size-4\" />\n        </ToolbarButton>\n      </DropdownMenuTrigger>\n\n      <DropdownMenuContent align=\"start\">\n        <DropdownMenuGroup>\n          <DropdownMenuItem\n            onSelect={() => {\n              openHtmlFilePicker();\n            }}\n          >\n            Import from HTML\n          </DropdownMenuItem>\n\n          <DropdownMenuItem\n            onSelect={() => {\n              openMdFilePicker();\n            }}\n          >\n            Import from Markdown\n          </DropdownMenuItem>\n\n          <DropdownMenuItem\n            onSelect={() => {\n              openDocxFilePicker();\n            }}\n          >\n            Import from Word\n          </DropdownMenuItem>\n        </DropdownMenuGroup>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n",
      "type": "registry:ui"
    }
  ],
  "meta": {
    "docs": [
      {
        "route": "/docs/import",
        "title": "Import"
      }
    ],
    "examples": [
      "basic-nodes-demo"
    ],
    "label": "New"
  }
}